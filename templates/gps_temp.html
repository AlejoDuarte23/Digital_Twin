<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Update a feature in realtime</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }

.marker {
  background-image: url('/static/models/truck.svg');
  background-size: cover;
  width: 25px;
  height: 25px;
  border-radius: 50%;
  cursor: pointer;
  color: #f7cf1f;
}

</style>
</head>
<body>
<div id="map"></div>

<script>
    /*
    mapboxgl.accessToken = 'pk.eyJ1IjoiYWxlam9kdWFydGUyMyIsImEiOiJja2wxMm1tMHUwYWdwMnd0NGI0emZrYTF5In0.2fceQ8K9H7KwH7tCSz_tWA';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-v9',
        zoom: 0
    });
    
    map.on('load', async () => {
        const eventSource = new EventSource("/stream-cords");
        let coordinates = [];
        let markers = [];
        
        eventSource.onmessage = function(event) {
            const coords = JSON.parse(event.data);
            coordinates.push(coords);
    
            map.jumpTo({ 'center': coordinates[0], 'zoom': 14 });
            map.setPitch(30);
    
            // Create a HTML element for the truck marker
            const el = document.createElement('div');
            el.className = 'marker';
    
            // Set the marker's coordinates and add it to the map
            const marker = new mapboxgl.Marker(el).setLngLat(coords).addTo(map);
            markers.push(marker);
    
            // Adjust the opacity of the markers based on their age
            markers.forEach((m, index) => {
                const opacity = (index + 1) / markers.length;
                m.getElement().style.opacity = opacity;
            });
    
            // Remove the oldest marker if there are more than 7 markers
            if (markers.length > 3) {
                markers.shift().remove();
            }
        };
    });

    */

    mapboxgl.accessToken = 'pk.eyJ1IjoiYWxlam9kdWFydGUyMyIsImEiOiJja2wxMm1tMHUwYWdwMnd0NGI0emZrYTF5In0.2fceQ8K9H7KwH7tCSz_tWA';
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-v9',

    });
    
    map.on('load', async () => {
        map.jumpTo({ 'center': [-72.63803, 11.05333], 'zoom': 12 ,'bearing': -7.20, 'pitch': 47.50});
        const eventSource = new EventSource("/stream-cords");
        let markers = {
            truck_1: null,
            truck_2: null,
            truck_3: null
        };
        
        eventSource.onmessage = function(event) {
            const coords = JSON.parse(event.data);
            
            for (let truck in coords) {
                if (markers[truck] === null) {
                    // Create a HTML element for the truck marker
                    const el = document.createElement('div');
                    el.className = 'marker';
                    
                    // Set the marker's coordinates and add it to the map
                    markers[truck] = new mapboxgl.Marker(el).setLngLat(coords[truck]).addTo(map);
                } else {
                    // Update the marker's coordinates
                    markers[truck].setLngLat(coords[truck]);
                }
            }

            // Center the map on the first truck's coordinates
            //map.jumpTo({ 'center': coords.truck_1, 'zoom': 14 });
            //map.setPitch(30);
        };
    });

    </script>

</body>
</html>